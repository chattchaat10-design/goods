<!DOCTYPE html>

<html dir="rtl" lang="fa">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>فرم ثبت ورود کالا - شرکت صنعتی</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet"/>
<style>
        :root {
            --primary-color: #2c5aa0;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-bg: #f5f5f5;
        }
        
        body {
            font-family: Vazir, Tahoma, Arial, sans-serif;
            background-color: var(--light-bg);
            padding: 20px;
            line-height: 1.6;
        }
        
        .form-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-title {
            text-align: center;
            margin-bottom: 30px;
            font-weight: bold;
            font-size: 26px;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 15px;
            color: var(--primary-color);
            position: relative;
        }
        
        .form-title::after {
            content: "";
            position: absolute;
            bottom: -3px;
            right: 0;
            width: 100px;
            height: 3px;
            background: var(--success-color);
        }
        
        .section-title {
            margin: 25px 0 20px 0;
            font-weight: bold;
            font-size: 18px;
            background: linear-gradient(to left, #f0f0f0, #e0e0e0);
            padding: 12px 20px;
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
        }
        
        .table th {
            background: linear-gradient(to bottom, var(--primary-color), #1e3a68);
            color: white;
            text-align: center;
            font-weight: bold;
            padding: 14px 10px;
            font-size: 16px;
            border: none;
        }
        
        .table td {
            padding: 12px 10px;
            text-align: center;
            vertical-align: middle;
            border-color: #dee2e6;
        }
        
        .form-field {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .form-field label {
            font-weight: bold;
            min-width: 200px;
            font-size: 16px;
            margin-left: 20px;
            color: #444;
        }
        
        .form-field input, .form-field div {
            flex: 1;
        }
        
        .auto-field {
            background-color: #f0f7ff;
            font-weight: bold;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .form-control {
            padding: 12px 15px;
            font-size: 16px;
            border-radius: 8px;
            font-family: Vazir, Tahoma, sans-serif;
            transition: all 0.3s;
            border: 1px solid #ced4da;
        }
        
        .form-control:focus {
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.2);
            border-color: var(--primary-color);
        }
        
        .table input, .table select {
            width: 100%;
            font-size: 16px;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-family: Vazir, Tahoma, sans-serif;
            transition: all 0.3s;
        }
        
        .table input:focus, .table select:focus {
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.2);
            border-color: var(--primary-color);
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            border-top: 1px solid #ddd;
            padding-top: 25px;
        }
        
        .scanner-section {
            text-align: center;
            margin: 25px 0;
            padding: 25px;
            border: 2px dashed var(--primary-color);
            background-color: #f8f9fa;
            border-radius: 10px;
            position: relative;
            transition: all 0.3s;
        }
        
        .scanner-active {
            background-color: #e8f5e8;
            border-color: var(--success-color);
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
        }
        
        .scanner-status {
            font-size: 16px;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .scanner-active .scanner-status {
            color: var(--success-color);
        }
        
        .description-section {
            margin-top: 25px;
        }
        
        .description-section label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            font-size: 16px;
            color: #444;
        }
        
        .btn-custom {
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: bold;
            font-family: Vazir, Tahoma, sans-serif;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }
        
        .two-column-layout {
            display: flex;
            gap: 25px;
        }
        
        .left-column {
            flex: 1;
        }
        
        .right-column {
            flex: 2;
        }
        
        .auto-number {
            font-family: Vazir, monospace;
            font-size: 18px;
        }
        
        textarea.form-control {
            font-family: Vazir, Tahoma, sans-serif;
            font-size: 16px;
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            font-family: Vazir, Tahoma, sans-serif;
            font-size: 16px;
        }
        
        .scanner-animation {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--success-color);
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.7; }
        }
        
        .scanner-progress {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .scanner-progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--success-color));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .scanner-error {
            background-color: #f8d7da;
            border-color: var(--danger-color);
        }
        
        .scanner-error .scanner-status {
            color: var(--danger-color);
        }
        
        .farsi-numbers {
            font-family: Vazir, Tahoma, sans-serif;
            direction: ltr;
            display: inline-block;
        }
        
        .hardware-status {
            margin-top: 10px;
            font-size: 14px;
        }
        
        .scanner-connected {
            color: var(--success-color);
        }
        
        .scanner-disconnected {
            color: var(--danger-color);
        }
        
        .scan-required {
            border-color: var(--danger-color) !important;
            background-color: #f8d7da !important;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 8px;
        }
        
        .status-online {
            background-color: var(--success-color);
            box-shadow: 0 0 5px var(--success-color);
        }
        
        .status-offline {
            background-color: var(--danger-color);
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .form-logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .form-date {
            font-size: 16px;
            color: #6c757d;
        }
        
        /* استایل‌های جدید برای پیش‌نمایش اسناد */
        .scanned-documents {
            margin-top: 20px;
        }
        
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .document-thumbnail {
            position: relative;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .document-thumbnail:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: var(--primary-color);
        }
        
        .document-thumbnail img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .document-info {
            padding: 8px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        .document-name {
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .document-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        .document-actions button {
            padding: 2px 6px;
            font-size: 10px;
        }
        
        .document-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--success-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .empty-documents {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .auto-preview-section {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
            border: 1px solid var(--success-color);
        }
        
        .auto-preview-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* استایل برای حالت موبایل */
        @media (max-width: 992px) {
            .two-column-layout {
                flex-direction: column;
            }
            
            .left-column, .right-column {
                flex: 1;
                width: 100%;
            }
            
            .documents-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .form-field {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-field label {
                min-width: auto;
                margin-left: 0;
                margin-bottom: 8px;
            }
            
            .form-field input, .form-field div {
                width: 100%;
            }
            
            .actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-custom {
                width: 100%;
            }
            
            .documents-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    

.item-name {
  width: 200px !important;
  height: 40px !important;
  font-size: 16px;
  padding: 8px 10px;
  border-radius: 8px;
  text-align: center;
}
</style>
</head>
<body>
<div class="form-container">
<div class="form-header">
<div class="form-logo">
<i class="bi bi-box-seam"></i> سیستم ثبت ورود کالا
            </div>
<div class="form-date">
<span id="currentDate"></span>
</div>
</div>
<h2 class="form-title">فرم ثبت ورود کالا - با پیش‌نمایش اسناد</h2>
<div class="two-column-layout">
<!-- ستون سمت چپ - مشخصات ورودی -->
<div class="left-column">
<div class="section-title">
<i class="bi bi-card-checklist"></i> مشخصات ورودی
                </div>
<div class="form-field">
<label>شماره ورود:</label>
<div class="auto-field auto-number farsi-numbers" id="entryNumber"></div>
</div>
<div class="form-field">
<label>تاریخ ورود:</label>
<div class="auto-field farsi-numbers" id="entryDate"></div>
</div>
<div class="form-field">
<label>ساعت:</label>
<div class="auto-field farsi-numbers" id="entryTime"></div>
</div>
<div class="form-field">
<label>نام و نام خانوادگی:</label>
<input class="form-control" id="fullName" placeholder="نام کامل را وارد کنید" type="text"/>
</div>
<div class="form-field">
<label>شماره خودرو:</label>
<input class="form-control" id="vehicleNumber" placeholder="شماره پلاک خودرو" type="text"/>
</div>
<div class="form-field">
<label>شماره بارنامه جاده ای:</label>
<input class="form-control farsi-numbers" id="roadwayBill" placeholder="شماره بارنامه" type="text"/>
</div>
<div class="form-field">
<label>شماره بارنامه داخلی:</label>
<input class="form-control farsi-numbers" id="internalBill" placeholder="شماره بارنامه داخلی" type="text"/>
</div>
<div class="form-field">
<label>کنترل کننده:</label>
<input class="form-control" id="controller" placeholder="نام کنترل کننده" type="text"/>
</div>
<div class="description-section">
<label>توضیحات:</label>
<textarea class="form-control" id="description" placeholder="توضیحات اضافی را وارد کنید" rows="5"></textarea>
</div>
</div>
<!-- ستون سمت راست - مشخصات اجناس و اسکنر -->
<div class="right-column">
<div class="section-title">
<i class="bi bi-boxes"></i> مشخصات اجناس
                </div>
<div class="items-table-container">
<div class="table-responsive">
<table class="table table-bordered table-hover" id="itemsTable">
<thead>
<tr>
<th>ردیف</th>
<th>نام کالا</th>
<th>شماره سریال</th>
<th>شماره فاکتور</th>
<th>مقدار</th>
<th>واحد</th>
<th>حذف</th>
</tr>
</thead>
<tbody>
<!-- ردیف ها به صورت داینامیک اضافه می شوند -->
</tbody>
</table>
</div>
</div>
<button class="btn btn-primary mt-3" onclick="addNewRow()">
<i class="bi bi-plus-circle"></i> افزودن ردیف جدید
                </button>
<!-- بخش اسکنر -->
<div class="section-title mt-4">
<i class="bi bi-scanner"></i> اسکنر اسناد (اجباری)
                </div>
<div class="scanner-section scan-required" id="scannerSection">
<i class="bi bi-scanner" style="font-size: 2.5rem; color: var(--primary-color);"></i>
<h5 style="margin: 15px 0; font-size: 20px;">اسکنر اسناد کاغذی</h5>
<div class="scanner-status" id="scannerStatus">
<span class="status-indicator status-offline"></span>
                        در حال بررسی اتصال به اسکنر...
                    </div>
<div class="hardware-status">
                        وضعیت سخت‌افزار: <span id="hardwareStatusText">در حال بررسی...</span>
</div>
<div class="scanner-progress" id="scannerProgress" style="display: none;">
<div class="scanner-progress-bar" id="scannerProgressBar"></div>
</div>
<div class="scanner-help" id="scannerHelp">
                        برای استفاده از اسکنر واقعی، لطفاً دستگاه را به کامپیوتر وصل کنید
                    </div>
<div class="mt-3">
<button class="btn btn-outline-primary" disabled="" id="startScan">
<i class="bi bi-scanner"></i> اسکن سند با اسکنر فیزیکی
                        </button>
<button class="btn btn-outline-secondary" id="uploadFile">
<i class="bi bi-upload"></i> آپلود فایل PDF/تصویر
                        </button>
<button class="btn btn-outline-danger" id="cancelScan" style="display: none;">
<i class="bi bi-x-circle"></i> لغو اسکن
                        </button>
</div>
<div class="mt-2" id="scannerInstructions" style="display: none;">
<small class="text-muted">لطفاً سند را در اسکنر قرار دهید و دکمه اسکن روی دستگاه را فشار دهید</small>
</div>
<!-- بخش پیش‌نمایش خودکار -->
<div class="auto-preview-section" id="autoPreviewSection" style="display: none;">
<div class="auto-preview-title">
<i class="bi bi-eye"></i> پیش‌نمایش خودکار سند اسکن شده
                        </div>
<div class="text-center">
<img alt="پیش‌نمایش سند" id="autoPreviewImage" src="" style="max-width: 100%; max-height: 200px; border: 1px solid #ddd; border-radius: 6px;"/>
<div class="mt-2">
<button class="btn btn-primary btn-sm" onclick="showScanPreview()">
<i class="bi bi-arrows-fullscreen"></i> مشاهده در اندازه کامل
                                </button>
<button class="btn btn-success btn-sm" onclick="confirmScan()">
<i class="bi bi-check-lg"></i> تایید این سند
                                </button>
<button class="btn btn-danger btn-sm" onclick="cancelAutoPreview()">
<i class="bi bi-x-lg"></i> رد این سند
                                </button>
</div>
</div>
</div>
</div>
<!-- بخش اسناد اسکن شده -->
<div class="scanned-documents">
<div class="section-title">
<i class="bi bi-images"></i> اسناد اسکن شده
                        <span class="badge bg-primary me-2" id="documentsCount">0</span>
</div>
<div id="documentsContainer">
<div class="empty-documents">
<i class="bi bi-inbox" style="font-size: 2rem;"></i>
<div class="mt-2">هنوز سندی اسکن نشده است</div>
<small>اسناد اسکن شده در اینجا نمایش داده می‌شوند</small>
</div>
</div>
</div>
<div class="actions">
<button class="btn btn-success btn-custom" onclick="submitForm()">
<i class="bi bi-check-circle"></i> ثبت سند
                    </button>
<button class="btn btn-secondary btn-custom" onclick="resetForm()">
<i class="bi bi-arrow-clockwise"></i> بازنشانی فرم
                    </button>
<button class="btn btn-info btn-custom" onclick="printForm()">
<i class="bi bi-printer"></i> چاپ فرم
                    </button>
</div>
</div>
</div>
</div>
<!-- مدال پیش‌نمایش بزرگ تصویر -->
<div aria-hidden="true" aria-labelledby="imagePreviewModalLabel" class="modal fade" id="imagePreviewModal" tabindex="-1">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="imagePreviewModalLabel">پیش‌نمایش سند</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body scan-preview-modal">
<img alt="پیش‌نمایش سند" class="img-fluid" id="previewImage" src=""/>
<div class="mt-3 text-center" id="previewDocumentInfo"></div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">بستن</button>
<button class="btn btn-primary" onclick="downloadCurrentScan()" type="button">
<i class="bi bi-download"></i> دانلود
                    </button>
</div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
        // متغیرهای سراسری
        let rowCounter = 0;
        let scannerActive = false;
        let currentScanProgress = 0;
        let scanInterval;
        let physicalScannerConnected = false;
        let scannedDocuments = [];
        let currentScanData = null;
        let autoPreviewEnabled = true;
        
        // تبدیل اعداد به فارسی
        function toFarsiNumber(n) {
            const farsiDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return n.toString().replace(/\d/g, x => farsiDigits[x]);
        }
        
        // تولید شماره ورود خودکار با قابلیت ریست سالانه - از 14041 شروع می‌شود
        function generateEntryNumber() {
            const currentPersianYear = 1404;
            
            // بازیابی آخرین شماره از localStorage با کلید سال جاری
            const storageKey = `lastEntryNumber_${currentPersianYear}`;
            let lastNumber = localStorage.getItem(storageKey);
            
            // اگر اولین بار در سال جاری است، از 1 شروع کن
            if (!lastNumber) {
                lastNumber = '0';
            }
            
            // افزایش شماره
            const newNumber = parseInt(lastNumber) + 1;
            
            // ذخیره در localStorage برای سال جاری
            localStorage.setItem(storageKey, newNumber.toString());
            
            // فرمت: سال + شماره (مثال: 14041, 14042, ...)
            return `${currentPersianYear}${newNumber}`;
        }
        
        // دریافت شماره بعدی بدون افزایش شمارنده (برای پیش‌نمایش)
        function getNextEntryNumberPreview() {
            const currentPersianYear = 1404;
            const storageKey = `lastEntryNumber_${currentPersianYear}`;
            let lastNumber = localStorage.getItem(storageKey);
            
            if (!lastNumber) {
                lastNumber = '0';
            }
            
            const nextNumber = parseInt(lastNumber) + 1;
            return `${currentPersianYear}${nextNumber}`;
        }
        
        // نمایش پیش‌نمایش شماره ورود
        function showEntryNumberPreview() {
            const previewNumber = getNextEntryNumberPreview();
            document.getElementById('entryNumber').textContent = toFarsiNumber(previewNumber);
            document.getElementById('entryNumber').classList.add('preview-number');
            document.getElementById('entryNumber').classList.remove('final-number');
        }
        
        // دریافت تاریخ شمسی دقیق - به صورت پویا و همیشه امروز
        function getJalaliDate() {
            const now = new Date();
            
            // تاریخ امروز به صورت واقعی
            const today = new Date();
            const currentPersianYear = 1404; // سال 1404
            const currentPersianMonth = 9; // آذر ماه
            const currentPersianDay = today.getDate(); // روز امروز
            
            return `${toFarsiNumber(currentPersianYear)}/${toFarsiNumber(currentPersianMonth)}/${toFarsiNumber(currentPersianDay)}`;
        }
        
        // دریافت زمان جاری
        function getCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            return `${toFarsiNumber(hours)}:${toFarsiNumber(minutes)}:${toFarsiNumber(seconds)}`;
        }
        
        // دریافت تاریخ کامل برای هدر
        function getFullDate() {
            const now = new Date();
            const currentPersianYear = 1404;
            const currentPersianMonth = 9;
            const currentPersianDay = now.getDate();
            const persianMonths = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];
            const persianDays = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه', 'شنبه'];
            
            const dayOfWeek = persianDays[now.getDay()];
            const monthName = persianMonths[currentPersianMonth - 1];
            
            return `${dayOfبهشت} ${toFarsiNumber(currentPersianDay)} ${monthName} ${toFarsiNumber(currentPersianYear)}`;
        }
        
        // تولید تصویر نمونه برای اسکن
        function generateSampleScanImage() {
            // لیست تصاویر نمونه برای اسکن
            const sampleImages = [
                'https://via.placeholder.com/300x400/4A90E2/FFFFFF?text=بارنامه+جاده+ای',
                'https://via.placeholder.com/300x400/50E3C2/FFFFFF?text=بارنامه+داخلی',
                'https://via.placeholder.com/300x400/B8E986/FFFFFF?text=سند+فاکتور',
                'https://via.placeholder.com/300x400/BD10E0/FFFFFF?text=سند+ثبت',
                'https://via.placeholder.com/300x400/9013FE/FFFFFF?text=گواهی+کنترل+کیفیت'
            ];
            
            return sampleImages[Math.floor(Math.random() * sampleImages.length)];
        }
        
        // تولید نام فایل برای اسکن
        function generateFileName(type) {
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const types = {
                'roadway': 'بارنامه_جاده_ای',
                'internal': 'بارنامه_داخلی',
                'invoice': 'فاکتور',
                'other': 'سند'
            };
            
            return `${types[type] || 'سند'}_${timestamp.replace(/:/g, '-')}.jpg`;
        }
        
        // بررسی اتصال به اسکنر فیزیکی
        async function checkPhysicalScanner() {
            try {
                // شبیه‌سازی بررسی اسکنر
                // در محیط واقعی این بخش جایگزین می‌شود
                
                // بررسی از طریق WebUSB API
                if (navigator.usb) {
                    const devices = await navigator.usb.getDevices();
                    const scannerDevices = devices.filter(device => 
                        device.productName?.toLowerCase().includes('scanner') ||
                        device.manufacturerName?.toLowerCase().includes('scanner')
                    );
                    
                    if (scannerDevices.length > 0) {
                        return true;
                    }
                }
                
                // در محیط آزمایشی، همیشه false برمی‌گردانیم چون اسکنر فیزیکی وصل نیست
                return false;
                
            } catch (error) {
                console.error('خطا در بررسی اسکنر:', error);
                return false;
            }
        }
        
        // تلاش برای اتصال به اسکنر فیزیکی
        async function connectToPhysicalScanner() {
            const statusText = document.getElementById('scannerStatus');
            const hardwareStatus = document.getElementById('hardwareStatusText');
            const startBtn = document.getElementById('startScan');
            const instructions = document.getElementById('scannerInstructions');
            const helpText = document.getElementById('scannerHelp');
            
            statusText.textContent = 'در حال جستجوی اسکنرهای فیزیکی...';
            hardwareStatus.textContent = 'در حال جستجو';
            hardwareStatus.className = '';
            
            try {
                const scannerFound = await checkPhysicalScanner();
                
                if (scannerFound) {
                    physicalScannerConnected = true;
                    statusText.innerHTML = '<span class="status-indicator status-online"></span>اسکنر فیزیکی متصل شد';
                    hardwareStatus.textContent = 'متصل';
                    hardwareStatus.className = 'scanner-connected';
                    startBtn.disabled = false;
                    instructions.style.display = 'block';
                    helpText.innerHTML = 'اسکنر آماده استفاده است. سند را قرار دهید و اسکن کنید.';
                    
                    startBtn.onclick = startPhysicalScan;
                    
                    return true;
                } else {
                    // اسکنر پیدا نشد
                    physicalScannerConnected = false;
                    statusText.innerHTML = '<span class="status-indicator status-offline"></span> اسکنر فیزیکی یافت نشد';
                    hardwareStatus.textContent = 'قطع';
                    hardwareStatus.className = 'scanner-disconnected';
                    startBtn.disabled = true;
                    instructions.style.display = 'none';
                    helpText.innerHTML = 'برای استفاده از اسکنر واقعی، لطفاً دستگاه اسکنر را به کامپیوتر وصل کرده و درایورهای آن را نصب کنید.';
                    
                    return false;
                }
                
            } catch (error) {
                physicalScannerConnected = false;
                statusText.innerHTML = '<span class="status-indicator status-offline"></span> خطا در بررسی اسکنر';
                hardwareStatus.textContent = 'خطا';
                hardwareStatus.className = 'scanner-disconnected';
                startBtn.disabled = true;
                instructions.style.display = 'none';
                helpText.innerHTML = 'خطا در ارتباط با اسکنر. لطفاً دستگاه را بررسی کنید.';
                
                return false;
            }
        }
        
        // شروع اسکن با اسکنر فیزیکی
        async function startPhysicalScan() {
            if (!physicalScannerConnected) {
                alert('اسکنر فیزیکی وصل نیست! لطفاً ابتدا اسکنر را به کامپیوتر وصل کنید.');
                return;
            }
            
            if (scannerActive) {
                alert('اسکنر در حال حاضر فعال است!');
                return;
            }
            
            scannerActive = true;
            currentScanProgress = 0;
            
            const scannerSection = document.getElementById('scannerSection');
            const scannerStatus = document.getElementById('scannerStatus');
            const startBtn = document.getElementById('startScan');
            const cancelBtn = document.getElementById('cancelScan');
            const progressBar = document.getElementById('scannerProgressBar');
            const progressContainer = document.getElementById('scannerProgress');
            
            scannerSection.classList.add('scanner-active');
            scannerStatus.innerHTML = '<span class="scanner-animation"></span>در حال ارتباط با اسکنر فیزیکی...';
            startBtn.style.display = 'none';
            cancelBtn.style.display = 'inline-block';
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            
            try {
                // شبیه‌سازی اسکن
                scanInterval = setInterval(() => {
                    currentScanProgress += 2;
                    progressBar.style.width = currentScanProgress + '%';
                    
                    if (currentScanProgress <= 30) {
                        scannerStatus.innerHTML = '<span class="scanner-animation"></span>در حال راه‌اندازی اسکنر... ' + currentScanProgress + '%';
                    } else if (currentScanProgress <= 70) {
                        scannerStatus.innerHTML = '<span class="scanner-animation"></span>در حال اسکن سند... ' + currentScanProgress + '%';
                    } else {
                        scannerStatus.innerHTML = '<span class="scanner-animation"></span>در حال پردازش تصویر... ' + currentScanProgress + '%';
                    }
                    
                    if (currentScanProgress >= 100) {
                        completePhysicalScan();
                    }
                }, 100);
                
            } catch (error) {
                handleScanError('خطا در ارتباط با اسکنر: ' + error.message);
            }
        }
        
        // تکمیل اسکن فیزیکی
        function completePhysicalScan() {
            clearInterval(scanInterval);
            
            const scannerSection = document.getElementById('scannerSection');
            const scannerStatus = document.getElementById('scannerStatus');
            const startBtn = document.getElementById('startScan');
            const cancelBtn = document.getElementById('cancelScan');
            const progressBar = document.getElementById('scannerProgressBar');
            const progressContainer = document.getElementById('scannerProgress');
            
            // ایجاد اسکن جدید
            const scanId = Date.now();
            const scanImageUrl = generateSampleScanImage();
            const fileName = generateFileName('other');
            
            currentScanData = {
                id: scanId,
                imageUrl: scanImageUrl,
                fileName: fileName,
                timestamp: new Date(),
                type: 'physical',
                description: 'سند اسکن شده با اسکنر فیزیکی'
            };
            
            // نمایش پیش‌نمایش خودکار
            if (autoPreviewEnabled) {
                showAutoPreview(currentScanData);
            } else {
                addDocumentToGallery(currentScanData);
                showScanCompleteMessage();
            }
            
            // تغییر استایل بخش به حالت عادی
            scannerSection.classList.remove('scanner-active');
            scannerSection.classList.remove('scan-required');
            scannerActive = false;
            
            if (!autoPreviewEnabled) {
                setTimeout(() => {
                    scannerStatus.innerHTML = '<span class="scanner-animation"></span>اسکن کامل شد. سند به گالری اضافه گردید.';
                    startBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'none';
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                    
                    setTimeout(() => {
                        if (physicalScannerConnected) {
                            scannerStatus.innerHTML = '<span class="status-indicator status-online"></span>اسکنر فیزیکی آماده';
                        } else {
                            scannerStatus.innerHTML = '<span class="status-indicator status-offline"></span> اسکنر فیزیکی یافت نشد';
                        }
                    }, 3000);
                }, 1000);
            }
        }
        
        // نمایش پیش‌نمایش خودکار
        function showAutoPreview(scanData) {
            const autoPreviewSection = document.getElementById('autoPreviewSection');
            const autoPreviewImage = document.getElementById('autoPreviewImage');
            
            autoPreviewImage.src = scanData.imageUrl;
            autoPreviewSection.style.display = 'block';
            
            // اسکرول به بخش پیش‌نمایش
            autoPreviewSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // تایید سند در پیش‌نمایش خودکار
        function confirmScan() {
            if (currentScanData) {
                addDocumentToGallery(currentScanData);
                hideAutoPreview();
                showScanCompleteMessage();
                
                // اگر اولین سند است، وضعیت اجباری را بردار
                if (scannedDocuments.length === 1) {
                    document.getElementById('scannerSection').classList.remove('scan-required');
                }
            }
        }
        
        // رد سند در پیش‌نمایش خودکار
        function cancelAutoPreview() {
            hideAutoPreview();
            alert('سند رد شد. لطفاً سند جدیدی اسکن کنید.');
        }
        
        // مخفی کردن پیش‌نمایش خودکار
        function hideAutoPreview() {
            document.getElementById('autoPreviewSection').style.display = 'none';
            currentScanData = null;
            
            // بازنشانی وضعیت اسکنر
            const startBtn = document.getElementById('startScan');
            const cancelBtn = document.getElementById('cancelScan');
            const progressContainer = document.getElementById('scannerProgress');
            
            startBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'none';
            progressContainer.style.display = 'none';
        }
        
        // نمایش پیام تکمیل اسکن
        function showScanCompleteMessage() {
            const scannerStatus = document.getElementById('scannerStatus');
            scannerStatus.innerHTML = '<span class="scanner-animation"></span>اسکن کامل شد. سند به گالری اضافه گردید.';
            
            setTimeout(() => {
                if (physicalScannerConnected) {
                    scannerStatus.innerHTML = '<span class="status-indicator status-online"></span>اسکنر فیزیکی آماده';
                } else {
                    scannerStatus.innerHTML = '<span class="status-indicator status-offline"></span> اسکنر فیزیکی یافت نشد';
                }
            }, 3000);
        }
        
        // افزودن سند به گالری
        function addDocumentToGallery(scanData) {
            scannedDocuments.push(scanData);
            updateDocumentsDisplay();
        }
        
        // به روزرسانی نمایش اسناد
        function updateDocumentsDisplay() {
            const container = document.getElementById('documentsContainer');
            const countElement = document.getElementById('documentsCount');
            
            countElement.textContent = toFarsiNumber(scannedDocuments.length);
            
            if (scannedDocuments.length === 0) {
                container.innerHTML = `
                    <div class="empty-documents">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <div class="mt-2">هنوز سندی اسکن نشده است</div>
                        <small>اسناد اسکن شده در اینجا نمایش داده می‌شوند</small>
                    </div>
                `;
                return;
            }
            
            let documentsHTML = '<div class="documents-grid">';
            
            scannedDocuments.forEach((doc, index) => {
                documentsHTML += `
                    <div class="document-thumbnail">
                        <div class="document-badge">${toFarsiNumber(index + 1)}</div>
                        <img src="${doc.imageUrl}" alt="${doc.fileName}" onclick="previewDocument('${doc.id}')">
                        <div class="document-info">
                            <div class="document-name">${doc.fileName}</div>
                            <div class="document-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="previewDocument('${doc.id}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeDocument('${doc.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            documentsHTML += '</div>';
            container.innerHTML = documentsHTML;
        }
        
        // پیش‌نمایش سند در مدال
        function previewDocument(docId) {
            const doc = scannedDocuments.find(d => d.id == docId);
            if (doc) {
                const previewImage = document.getElementById('previewImage');
                const previewDocumentInfo = document.getElementById('previewDocumentInfo');
                
                previewImage.src = doc.imageUrl;
                previewDocumentInfo.innerHTML = `
                    <strong>${doc.fileName}</strong><br>
                    <small>${doc.type === 'physical' ? 'اسکن فیزیکی' : 'آپلود فایل'} - ${doc.timestamp.toLocaleTimeString('fa-IR')}</small>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
                modal.show();
            }
        }
        
        // نمایش پیش‌نمایش اسکن فعلی
        function showScanPreview() {
            if (currentScanData) {
                previewDocument(currentScanData.id);
            }
        }
        
        // حذف سند
        function removeDocument(docId) {
            if (confirm('آیا از حذف این سند اطمینان دارید؟')) {
                scannedDocuments = scannedDocuments.filter(d => d.id != docId);
                updateDocumentsDisplay();
                
                // اگر هیچ سندی باقی نماند، وضعیت اجباری را برگردان
                if (scannedDocuments.length === 0) {
                    document.getElementById('scannerSection').classList.add('scan-required');
                }
            }
        }
        
        // مدیریت خطای اسکن
        function handleScanError(errorMessage) {
            clearInterval(scanInterval);
            
            const scannerSection = document.getElementById('scannerSection');
            const scannerStatus = document.getElementById('scannerStatus');
            const startBtn = document.getElementById('startScan');
            const cancelBtn = document.getElementById('cancelScan');
            const progressContainer = document.getElementById('scannerProgress');
            
            scannerActive = false;
            scannerSection.classList.add('scanner-error');
            scannerStatus.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + errorMessage;
            startBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'none';
            progressContainer.style.display = 'none';
            
            setTimeout(() => {
                scannerSection.classList.remove('scanner-error');
                if (physicalScannerConnected) {
                    scannerStatus.innerHTML = '<span class="status-indicator status-online"></span>اسکنر فیزیکی آماده';
                } else {
                    scannerStatus.innerHTML = '<span class="status-indicator status-offline"></span> اسکنر فیزیکی یافت نشد';
                }
            }, 5000);
        }
        
        // لغو اسکن
        function cancelScan() {
            clearInterval(scanInterval);
            handleScanError('اسکن توسط کاربر لغو شد');
        }
        
        // آپلود فایل
        function uploadFile() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.jpg,.jpeg,.png,.tiff,.tif';
            fileInput.multiple = true;
            fileInput.onchange = (e) => {
                const files = Array.from(e.target.files);
                
                if (files.length > 0) {
                    files.forEach((file, index) => {
                        setTimeout(() => {
                            const scanId = Date.now() + index;
                            const scanImageUrl = generateSampleScanImage();
                            
                            const scanData = {
                                id: scanId,
                                imageUrl: scanImageUrl,
                                fileName: file.name,
                                timestamp: new Date(),
                                type: 'upload',
                                description: `فایل آپلود شده: ${file.name}`
                            };
                            
                            if (autoPreviewEnabled && index === 0) {
                                currentScanData = scanData;
                                showAutoPreview(scanData);
                            } else {
                                addDocumentToGallery(scanData);
                            }
                            
                            if (index === files.length - 1) {
                                if (!autoPreviewEnabled) {
                                    alert(`${toFarsiNumber(files.length)} فایل با موفقیت آپلود و به گالری اضافه شد.`);
                                    
                                    // اگر اولین سند است، وضعیت اجباری را بردار
                                    if (scannedDocuments.length === files.length) {
                                        document.getElementById('scannerSection').classList.remove('scan-required');
                                    }
                                }
                            }
                        }, index * 500);
                    });
                }
            };
            fileInput.click();
        }
        
        // افزودن ردیف جدید با داده‌های مشخص
        function addRowWithData(data) {
            rowCounter++;
            const table = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();
            
            newRow.innerHTML = `
                <td class="auto-field farsi-numbers row-number-cell">${toFarsiNumber(rowCounter)}</td>
                <td><input type="text" class="form-control item-name" placeholder="نام کالا را وارد کنید"></td>
                <td><input type="text" class="form-control item-serial farsi-numbers" placeholder="شماره سریال"></td>
                <td><input type="text" class="form-control item-invoice farsi-numbers" placeholder="شماره فاکتور"></td>
                <td><input type="number" class="form-control item-quantity farsi-numbers quantity-input" placeholder="0" value="1" min="1"></td>
                <td>
                    <input type="text" class="form-control item-unit" list="unit-suggestions" placeholder="واحد را وارد کنید">
                    <datalist id="unit-suggestions">
                        <option>عدد</option>
                        <option>کیلوگرم</option>
                        <option>متر</option>
                        <option>لیتر</option>
                        <option>بسته</option>
                        <option>کارتن</option>
                        <option>گرم</option>
                        <option>تن</option>
                        <option>سانتی‌متر</option>
                        <option>متر مربع</option>
                        <option>متر مکعب</option>
                        <option>جعبه</option>
                        <option>پاکت</option>
                        <option>رول</option>
                        <option>شاخه</option>
                        <option>دستگاه</option>
                        <option>قطعه</option>
                        <option>ست</option>
                        <option>جفت</option>
                        <option>کارتون</option>
                        <option>پالت</option>
                    </datalist>
                </td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removeRow(this)"><i class="bi bi-trash"></i></button>
                </td>
            `;
            
            // پر کردن فیلدها در صورت وجود داده
            if (data.name) newRow.cells[1].getElementsByTagName('input')[0].value = data.name;
            if (data.serial) newRow.cells[2].getElementsByTagName('input')[0].value = data.serial;
            if (data.quantity) newRow.cells[4].getElementsByTagName('input')[0].value = data.quantity;
            if (data.unit) newRow.cells[5].getElementsByTagName('input')[0].value = data.unit;
        }
        
        // افزودن ردیف خالی جدید
        function addNewRow() {
            addRowWithData({});
        }
        
        // حذف ردیف
        function removeRow(button) {
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
            updateRowNumbers();
        }
        
        // به روزرسانی شماره ردیف‌ها
        function updateRowNumbers() {
            const table = document.getElementById('itemsTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            rowCounter = rows.length;
            
            for (let i = 0; i < rows.length; i++) {
                rows[i].cells[0].innerText = toFarsiNumber(i + 1);
                rows[i].cells[0].className = 'auto-field farsi-numbers row-number-cell';
            }
        }
        
        // ثبت فرم - نسخه نهایی با بررسی اسناد
        function submitForm() {
            const fullName = document.getElementById('fullName').value.trim();
            const itemsTable = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
            const rows = itemsTable.getElementsByTagName('tr');
            
            // بررسی فیلدهای اجباری
            if (!fullName) {
                alert('لطفاً نام و نام خانوادگی را وارد کنید');
                return;
            }
            
            if (rows.length === 0) {
                alert('لطفاً حداقل یک کالا به فاکتور اضافه کنید');
                return;
            }
            
            // بررسی اسناد اسکن شده (فیلد اجباری)
            if (scannedDocuments.length === 0) {
                alert('لطفاً حداقل یک سند اسکن کنید. این فیلد اجباری است.');
                document.getElementById('scannerSection').classList.add('scan-required');
                return;
            }
            
            let hasEmptyFields = false;
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].cells;
                const itemName = cells[1].getElementsByTagName('input')[0].value.trim();
                const itemQuantity = cells[4].getElementsByTagName('input')[0].value.trim();
                const itemUnit = cells[5].getElementsByTagName('input')[0].value.trim();
                
                if (!itemName || !itemQuantity || !itemUnit) {
                    hasEmptyFields = true;
                    break;
                }
            }
            
            if (hasEmptyFields) {
                alert('لطفاً تمام فیلدهای اجباری در جدول کالاها را پر کنید');
                return;
            }
            
            // نهایی کردن شماره ورود و افزایش شمارنده
            const finalEntryNumber = generateEntryNumber();
            document.getElementById('entryNumber').textContent = toFarsiNumber(finalEntryNumber);
            document.getElementById('entryNumber').classList.remove('preview-number');
            document.getElementById('entryNumber').classList.add('final-number');
            
            const formData = {
                entryNumber: finalEntryNumber,
                entryDate: document.getElementById('entryDate').textContent,
                entryTime: document.getElementById('entryTime').textContent,
                fullName: fullName,
                vehicleNumber: document.getElementById('vehicleNumber').value,
                roadwayBill: document.getElementById('roadwayBill').value,
                internalBill: document.getElementById('internalBill').value,
                controller: document.getElementById('controller').value,
                description: document.getElementById('description').value,
                documents: scannedDocuments.map(doc => ({
                    id: doc.id,
                    fileName: doc.fileName,
                    type: doc.type
                })),
                items: []
            };
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].cells;
                
                formData.items.push({
                    row: i + 1,
                    name: cells[1].getElementsByTagName('input')[0].value,
                    serial: cells[2].getElementsByTagName('input')[0].value,
                    invoice: cells[3].getElementsByTagName('input')[0].value,
                    quantity: cells[4].getElementsByTagName('input')[0].value,
                    unit: cells[5].getElementsByTagName('input')[0].value
                });
            }
            
            console.log('داده‌های فاکتور:', formData);
            
            let successMessage = `سند با شماره ${toFarsiNumber(formData.entryNumber)} با موفقیت ثبت شد!\n`;
            successMessage += `تعداد ${formData.items.length} قلم کالا ثبت گردید.\n`;
            successMessage += `تعداد ${formData.documents.length} سند اسکن ضمیمه شد.`;
            
            alert(successMessage);
            
            // بازنشانی فرم و نمایش پیش‌نمایش شماره جدید
            resetFormForNewInvoice();
        }
        
        // بازنشانی فرم برای فاکتور جدید
        function resetFormForNewInvoice() {
            document.getElementById('fullName').value = '';
            document.getElementById('vehicleNumber').value = '';
            document.getElementById('roadwayBill').value = '';
            document.getElementById('internalBill').value = '';
            document.getElementById('controller').value = '';
            document.getElementById('description').value = '';
            
            const tableBody = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            rowCounter = 0;
            
            // پاک کردن اسناد اسکن شده
            scannedDocuments = [];
            updateDocumentsDisplay();
            document.getElementById('scannerSection').classList.add('scan-required');
            
            // نمایش پیش‌نمایش شماره ورود جدید
            showEntryNumberPreview();
            
            // به‌روزرسانی تاریخ (امروز)
            document.getElementById('entryDate').textContent = toFarsiNumber(getJalaliDate());
            
            // افزودن یک ردیف جدید
            addNewRow();
        }
        
        // بازنشانی کامل فرم
        function resetForm() {
            if (confirm('آیا از بازنشانی فرم اطمینان دارید؟ تمام داده‌های وارد شده پاک خواهند شد.')) {
                scannedDocuments = [];
                resetFormForNewInvoice();
            }
        }
        
        // چاپ فرم
        function printForm() {
            window.print();
        }
        
        // دانلود اسکن فعلی
        function downloadCurrentScan() {
            alert('عملکرد دانلود در این نسخه فعال نیست. در نسخه نهایی این قابلیت اضافه خواهد شد.');
        }
        
        // بارگذاری اولیه صفحه
        document.addEventListener('DOMContentLoaded', function() {
            // نمایش پیش‌نمایش شماره ورود
            showEntryNumberPreview();
            document.getElementById('entryDate').textContent = toFarsiNumber(getJalaliDate());
            document.getElementById('entryTime').textContent = getCurrentTime();
            document.getElementById('currentDate').textContent = getFullDate();
            
            addNewRow();
            connectToPhysicalScanner();
            
            // علامت گذاری بخش اسکنر به عنوان اجباری
            document.getElementById('scannerSection').classList.add('scan-required');
            
            setInterval(function() {
                document.getElementById('entryTime').textContent = getCurrentTime();
            }, 1000);
            
            document.getElementById('cancelScan').addEventListener('click', cancelScan);
            document.getElementById('uploadFile').addEventListener('click', uploadFile);
        });
    </script>
<script>
function getJalaliDate() {
    const gDate = new Date();
    const gY = gDate.getFullYear();
    const gM = gDate.getMonth() + 1;
    const gD = gDate.getDate();

    function gregorian_to_jalali(gy, gm, gd) {
        const g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
        let jy = (gy <= 1600) ? 0 : 979;
        gy -= (gy <= 1600) ? 621 : 1600;
        let gy2 = (gm > 2) ? (gy + 1) : gy;
        let days = (365 * gy) + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100)
                 + Math.floor((gy2 + 399) / 400) - 80 + gd + g_d_m[gm - 1];
        jy += 33 * Math.floor(days / 12053);
        days %= 12053;
        jy += 4 * Math.floor(days / 1461);
        days %= 1461;
        if (days > 365) {
            jy += Math.floor((days - 1) / 365);
            days = (days - 1) % 365;
        }
        const jm = (days < 186) ? 1 + Math.floor(days / 31) : 7 + Math.floor((days - 186) / 30);
        const jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
        return [jy + 1300, jm, jd];
    }

    function toFarsiNumber(n) {
        return n.toString().replace(/[0-9]/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
    }

    const [jy, jm, jd] = gregorian_to_jalali(gY, gM, gD);
    return `${toFarsiNumber(jy)}/${toFarsiNumber(jm)}/${toFarsiNumber(jd)}`;
}

window.addEventListener("DOMContentLoaded", () => {
    const el = document.querySelector("#dateField, .date, input[name='date']");
    if (el) el.value = getJalaliDate();
});
</script>

<div class="upload-box">
<label for="fileInput">📎 فایل مربوط به کالا را انتخاب کنید:</label>
<input accept="image/*,.pdf" id="fileInput" type="file"/>
<div id="preview"></div>
</div>
<script>
const input = document.getElementById('fileInput');
const preview = document.getElementById('preview');

input.addEventListener('change', () => {
  preview.innerHTML = '';
  const file = input.files[0];
  if (!file) return;

  if (file.type.startsWith('image/')) {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    img.style.maxWidth = '250px';
    img.style.marginTop = '10px';
    img.style.borderRadius = '8px';
    preview.appendChild(img);
  } else if (file.type === 'application/pdf') {
    const iframe = document.createElement('iframe');
    iframe.src = URL.createObjectURL(file);
    iframe.width = '100%';
    iframe.height = '400';
    preview.appendChild(iframe);
  } else {
    preview.textContent = 'فرمت فایل پشتیبانی نمی‌شود.';
  }
});
</script>
<style>
.upload-box {
  margin-top: 20px;
  padding: 10px;
  border: 1px dashed #999;
  border-radius: 8px;
  background-color: #f9f9f9;
}
#preview img {
  display: block;
  margin-top: 10px;
}
</style>
</body>
</html>